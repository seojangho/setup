#!/usr/bin/zsh

set -e

GITPATH=$(git rev-parse --show-toplevel)
DIR=~/.remote-maven/$(hostname)$GITPATH

if [[ "$1" == '--shell' ]]; then
  ssh -t cmscluster.snu.ac.kr -- "cd \"$DIR\"; $SHELL"
  exit 0
fi

function cleanup {
  set +e
  ssh cmscluster.snu.ac.kr -- jps | awk '"'"'{print $1}'"'"' | xargs -L1 -- kill -9
  exit $1
}

trap 'cleanup $?' EXIT

cd "$GITPATH"
ssh cmscluster.snu.ac.kr -- rm -rf \"$DIR\"
ssh cmscluster.snu.ac.kr -- mkdir -p \"$DIR\"
rsync -avz --delete -0 --files-from <(git ls-files -z) . "cmscluster.snu.ac.kr:$DIR"
ssh -t cmscluster.snu.ac.kr -- "cd \"$DIR\" && pwd && /usr/bin/mvn $@"
rsync -az --update "cmscluster.snu.ac.kr:~/.m2/" ~/.m2/
rsync -az --update  "cmscluster.snu.ac.kr:${DIR}/" ./
exit 0
