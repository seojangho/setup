#!/bin/bash

set -e

OPT="$1"

test_scrub() {
  if [[ ! -d "$1" ]]; then
    return 0
  fi
  if sudo btrfs scrub status "$1" | grep -P 'no stats available|running for' > /dev/null; then
    if [[ "$OPT" == '--notify-send' ]]; then
      notify-send -i disk-manager 'scrub is running' "scrub is running for $1"
    else
      >&2 echo "scrub is running for $1"
    fi
    return 1
  else
    return 0
  fi
}

test_scrub /
test_scrub /srv/data

exit 0
