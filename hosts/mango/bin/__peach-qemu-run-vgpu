#!/bin/bash

# usage: __peach-qemu-run-vgpu <NUM_CORES> <NUM_THREADS> <MEM_IN_MEGABYTES> <OTHER_PARAMS...>

set -euo pipefail

NUM_CORES=$1
NUM_THREADS=$2
MEM_IN_MEGABYTES=$3
OTHER_PARAMS=("${@:4}")

VARS="$(sudo mktemp -d)/MY_VARS.fd"
PULSE_SOCKET=/run/user/${UID}/pulse/native

sudo cp /usr/share/ovmf/x64/OVMF_VARS.fd "${VARS}"
sudo mount -t hugetlbfs hugetlbfs /dev/hugepages
sudo sysctl vm.nr_hugepages="${MEM_IN_MEGABYTES}"
# https://bugs.launchpad.net/qemu/+bug/1826422
sudo PULSE_COOKIE="${HOME}/.config/pulse/cookie" qemu-system-x86_64 \
  -name jangho-qemu-peach \
  -drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/OVMF_CODE.fd \
  -drive "if=pflash,format=raw,file=${VARS}" \
  -enable-kvm -machine q35,accel=kvm,kernel_irqchip=on -device intel-iommu -m "${MEM_IN_MEGABYTES}M" -mem-path /dev/hugepages \
  -cpu host,+topoext,kvm=off,hv_vendor_id=seojangho012,hv_time,hv_relaxed,hv_vapic,hv_spinlocks=0x1fff,+svm \
  -smp "$((NUM_CORES * NUM_THREADS)),sockets=1,cores=${NUM_CORES},threads=${NUM_THREADS}" \
  -vga virtio -nographic -vnc 127.0.0.1:0 \
  -object iothread,id=io-disk0 \
  -drive file=/dev/mapper/peach,format=raw,if=none,id=drive-virtio-disk0,aio=threads \
  -device "virtio-blk-pci,num-queues=$((NUM_CORES * NUM_THREADS)),drive=drive-virtio-disk0,id=virtio-disk0,iothread=io-disk0" \
  -object iothread,id=io-disk1 \
  -drive file=/dev/mapper/peach-tmp,format=raw,if=none,id=drive-virtio-disk1,aio=threads \
  -device "virtio-blk-pci,num-queues=$((NUM_CORES * NUM_THREADS)),drive=drive-virtio-disk1,id=virtio-disk1,iothread=io-disk1" \
  -usb -device usb-host,vendorid=1386,productid=884 \
  -monitor "unix:${HOME}/.cache/jangho-qemu-peach-monitor-socket,server,nowait" \
  -netdev user,id=net0,hostfwd=tcp::3389-:3389 -device virtio-net,netdev=net0 \
  -soundhw hda -audiodev id=pa,driver=pa,server="${PULSE_SOCKET}" \
  "${OTHER_PARAMS[@]}"
#view: spicy --title peach 127.0.0.1 -p 5930
sudo sysctl vm.nr_hugepages=0
sudo umount /dev/hugepages
exit 0
